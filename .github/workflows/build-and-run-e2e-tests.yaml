name: build-and-run-e2e-tests

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - 'LICENSE'
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - 'LICENSE'

concurrency:
  group: ${{ github.head_ref || github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  e2e-test:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    env:
      working-directory: .

    steps:
      - name: Check out code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.ref || github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0

      - name: Free disk space
        uses: ./.github/workflows/free-disk-space

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: ${{env.working-directory}}/go.mod

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: 3.11

      - name: Setup KinD cluster
        id: kind
        uses: helm/kind-action@v1.13.0
        with:
          cluster_name: kpu
          version: v0.30.0
          config: test/kind.yaml
          registry: true
          registry_name: registry
          registry_port: 5001
          registry_enable_delete: true

      - name: Print KinD node
        run: |
          kubectl describe nodes

      - name: Install Gateway API CRDs
        run: |
          kubectl apply --server-side -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.1/experimental-install.yaml
          kubectl wait --for=condition=Established --timeout=60s crd/gatewayclasses.gateway.networking.k8s.io
          kubectl wait --for=condition=Established --timeout=60s crd/gateways.gateway.networking.k8s.io
          kubectl wait --for=condition=Established --timeout=60s crd/grpcroutes.gateway.networking.k8s.io

      - name: Install Contour
        run: |
          kubectl apply --server-side -k config/contour
          kubectl wait --for=condition=Established --timeout=60s crd/contourdeployments.projectcontour.io
          kubectl wait --for=condition=Available=true --timeout=60s deployment -n projectcontour contour-gateway-provisioner

      - name: Build and push KPU operator image
        run: |
          IMAGE_BASE=${{ steps.kind.outputs.LOCAL_REGISTRY }}
          make build-operator-image -e IMAGE_BASE="${IMAGE_BASE}"
          make push-operator-image -e IMAGE_BASE="${IMAGE_BASE}"

      - name: Build and load KPU PyTorch server image
        run: |
          IMAGE_TAG="kpu-torch-server:test"
          docker build -f cmd/server/torch/Containerfile -t "${IMAGE_TAG}" .
          kind load docker-image "${IMAGE_TAG}" --name kpu

      - name: Deploy KPU operator
        id: deploy
        run: |
          IMAGE_BASE=${{ steps.kind.outputs.LOCAL_REGISTRY }}
          make deploy-operator -e IMAGE_BASE="${IMAGE_BASE}" -e ENV="e2e"
          kubectl wait --for=condition=Available=true --timeout=60s deployment -n kpu-system kpu-operator
          kubectl wait --for=condition=Programmed --timeout=60s gateway -n kpu-system kpu-gateway

      - name: Install test dependencies
        run: |
          pip install -e ".[test,torch]"

      - name: Run E2E tests
        run: |
          TEST_IMAGE="kpu-torch-server:test"
          echo "Using test image: ${TEST_IMAGE}"
          KPU_TEST_IMAGE="${TEST_IMAGE}" pytest test/ -v -m e2e

      - name: Print operator logs
        if: always() && steps.deploy.outcome == 'success'
        run: |
          kubectl logs --tail -1 -n kpu-system -l app.kubernetes.io/name=operator -f | tee ${RUNNER_TEMP}/kpu-operator.log &
          kubectl scale deployment -n kpu-system kpu-operator --replicas 0
          kubectl wait --for=delete pods --timeout=60s -n kpu-system -l app.kubernetes.io/name=operator
          wait

      - name: Export KinD logs
        if: always() && steps.kind.outcome == 'success'
        run: |
          kind export logs ${RUNNER_TEMP} --name kpu

      - name: Upload KinD logs
        uses: actions/upload-artifact@v5
        if: always() && steps.kind.outcome == 'success'
        with:
          name: logs
          retention-days: 10
          path: |
            ${{ runner.temp }}/**/*.log
